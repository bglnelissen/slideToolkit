#!/bin/bash
#
# Description: Tiff2Tiles using openslide
# Copyright (C) 2014, B.G.L. Nelissen. All rights reserved.
# Last edit: 8 march 2014
#
# License here.
#
<<<<<<< HEAD
=======
#
# License here
#
# Respect the Google Shell style guide.
# http://google-styleguide.googlecode.com/svn/trunk/shell.xml
>>>>>>> FETCH_HEAD

# aperio magnifications: tiffinfo aperio.svs |grep -w AppMag| sed 's/.*\(AppMag\ =\ [0-9]\{1,2\}\).*/\1/'

# debug
DEBUG=false
debug(){
  if [[ $DEBUG==true ]];then
    echo "$@"
  fi
}

# set variables
FILE="$1"
# path variables
FILEFULL="$(echo $(cd $(dirname $FILE); pwd)/$(basename $FILE))" # full path $FULL
FILEPATH="${FILEFULL%.*}"           # full path, no extension
FOLDERPATH=$(dirname "$FILEFULL")   # folder path
BASENAME=$(basename "$FILEFULL")    # basename
FILENAME="${BASENAME%.*}"           # basename, no extension"
EXTENSION="${BASENAME##*.}"         # extension
SLIDE="$FILE[0]"
TILESWIDTH=2000
TILESHEIGHT=2000

# create tiles per row, measure dimentions of newly create image
width=$(identify -format "%w" "$SLIDE")
height=$(identify -format "%h" "$SLIDE")
dimensions=${width}x${height}
limit_w=$((($width / $TILESWIDTH)-1))
limit_h=$((($height / $TILESHEIGHT)-1))
debug "$(date)"
debug "Start creating tiles..."
debug "width      $width"
debug "height     $height"
debug "dimensions $dimensions"
debug "limit_w    $limit_w"
debug "limit_h    $limit_h"
for y in $(seq 0 $limit_h); do
  for x in $(seq 0 $limit_w); do
    # one tile
    TILE="${FILEPATH}.X${y}.Y${x}.tile.png"
    w=$((x * $TILESWIDTH))
    h=$((y * $TILESHEIGHT))
    # openslide-write-png [OPTION...] slide x y level width height output.png
    openslide-write-png "$FILEFULL" "$w" "$h" 0 "$TILESWIDTH" "$TILESHEIGHT" "$TILE"

    # find tissue using some magick
    if [ $(wc -c < $TILE ) -ge 100000 ]; then
      # more than 100000 bytes...
      VERBOSE=$( convert $TILE -colorspace HSL -verbose info: );
      RGBO=$( echo "$VERBOSE" | grep mean | awk '{print $2}' )
      RED=$( echo $RGBO | awk '{print $1}'  | cut -d. -f1 ); 
      GREEN=$( echo $RGBO | awk '{print $2}'| cut -d. -f1 ); 
      BLUE=$( echo $RGBO | awk '{print $3}' | cut -d. -f1 );
      BLUESD=$( echo "$VERBOSE" | grep 'standard deviation' | awk '{print $3}' | sed -n 3p | cut -d. -f1 )
    if [ $RED -ge 51 ] && [ $GREEN -ge 12 ]; then 
      TISSUE="tissue";
    elif [ $BLUESD -ge 6 ]; then  
      TISSUE="tissue"; 
    else
      TISSUE="empty"; 
    fi; 
  else 
    TISSUE="empty"; 
  fi;
  # rename file
  mv -v "$TILE" "${TILE%.*}.${TISSUE}.png"
done
done